import{c as Z,j as l,p as Q,_ as ee,I as ge,F as fe,a as X,x as ye,w as be,$ as Ce,u as j}from"./index-12920841.js";import{C as we,a as Ne,b as xe,d as Ae,c as Te}from"./card-35f92528.js";import{T as Se}from"./textarea-6d9dd0d9.js";import{U as Pe}from"./upload-cloud-f0dda426.js";import{X as ve}from"./x-circle-58df0267.js";import{b as G}from"./boogasiAiClient-1caa78b9.js";import{C as ke}from"./clock-5987ac1e.js";import{R as De}from"./refresh-cw-3a7dbd64.js";import{C as Me}from"./cpu-8c7c0810.js";const Oe=Z("AlertCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]),$e=Z("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]),Ie=Z("LineChart",[["path",{d:"M3 3v18h18",key:"1s2lah"}],["path",{d:"m19 9-5 5-4-4-3 3",key:"2osh9i"}]]),je=Z("Target",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]),z=10,Le=({selectedFiles:t,handleFileChange:e,removeFile:n,manualTransactions:a,setManualTransactions:o,acceptedFileTypes:r})=>l.jsxs(we,{className:"glassmorphic shadow-xl border-[hsl(var(--brighter-teal))]/30 bg-[hsl(var(--card-bg-bright-teal-tint))]",children:[l.jsxs(Ne,{children:[l.jsx(xe,{className:"text-2xl text-primary-foreground",children:"Input Your Financial Data"}),l.jsxs(Ae,{className:"text-muted-foreground",children:["Upload up to ",z," files (CSV, PDF, PNG, JPG) or paste transaction data."]})]}),l.jsxs(Te,{className:"space-y-6",children:[l.jsxs("div",{children:[l.jsxs(Q,{htmlFor:"transactions-file-input",className:"text-lg font-medium text-primary-foreground",children:["Upload Files (Max ",z,")"]}),l.jsx("div",{className:"mt-2 flex justify-center px-6 pt-5 pb-6 border-2 border-dashed rounded-md border-muted-foreground/50 hover:border-[hsl(var(--boogasi-green-val))] transition-colors",children:l.jsxs("div",{className:"space-y-1 text-center",children:[l.jsx(Pe,{className:ee("mx-auto h-12 w-12 text-muted-foreground icon-neon-green file-upload-icon")}),l.jsxs("div",{className:"flex text-sm text-muted-foreground",children:[l.jsxs("label",{htmlFor:"transactions-file-input",className:"relative cursor-pointer rounded-md font-medium text-[hsl(var(--boogasi-blue-val))] hover:text-[hsl(var(--boogasi-blue-val))]/80 focus-within:outline-none focus-within:ring-2 focus-within:ring-ring focus-within:ring-offset-2",children:[l.jsx("span",{children:"Select files"}),l.jsx(ge,{id:"transactions-file-input",name:"transactions-file-input",type:"file",className:"sr-only",onChange:e,accept:r,multiple:!0,disabled:t.length>=z})]}),l.jsx("p",{className:"pl-1",children:"or drag and drop"})]}),l.jsx("p",{className:"text-xs text-muted-foreground",children:"CSV, PDF, PNG, JPG up to 5MB each"})]})}),t.length>0&&l.jsxs("div",{className:"mt-4 space-y-2",children:[l.jsxs("p",{className:"text-sm font-medium text-primary-foreground",children:["Selected Files (",t.length,"/",z,"):"]}),l.jsx("ul",{className:"max-h-40 overflow-y-auto space-y-1 rounded-md border border-border p-2 bg-input/50",children:t.map((s,i)=>l.jsxs("li",{className:"flex items-center justify-between text-sm text-muted-foreground p-1.5 rounded hover:bg-muted/50",children:[l.jsxs("div",{className:"flex items-center truncate",children:[l.jsx(fe,{className:ee("h-4 w-4 mr-2 flex-shrink-0 icon-neon-green selected-file-icon")}),l.jsx("span",{className:"truncate",title:s.name,children:s.name})]}),l.jsx(X,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>n(i),children:l.jsx(ve,{className:"h-4 w-4 text-[hsl(var(--boogasi-pink-val))]"})})]},i))})]})]}),l.jsxs("div",{className:"relative",children:[l.jsx("div",{className:"absolute inset-0 flex items-center",children:l.jsx("span",{className:"w-full border-t border-border"})}),l.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:l.jsx("span",{className:"bg-card px-2 text-muted-foreground",children:"Or"})})]}),l.jsxs("div",{children:[l.jsx(Q,{htmlFor:"manual-transactions",className:"text-lg font-medium text-primary-foreground",children:"Manual Transaction Input (CSV Format)"}),l.jsx(Se,{id:"manual-transactions",placeholder:"Paste transactions here (e.g., Date,Description,Category,Amount)...",className:"mt-2 min-h-[150px] bg-input text-foreground placeholder:text-muted-foreground border-border focus:border-[hsl(var(--brighter-teal))] focus:ring-[hsl(var(--brighter-teal))]",value:a,onChange:s=>o(s.target.value)}),l.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Format: Date, Description, Category, Amount (one transaction per line)."})]})]})]}),U=({icon:t,title:e,onClick:n})=>l.jsxs(X,{variant:"outline",className:"w-full justify-start space-x-2",onClick:n,children:[t,l.jsx("span",{children:e})]}),Re=["previous","account","statement","cheque no","page \\d+ of \\d+","customer service","contact us","important information","transactions since last statement","www\\.","\\.com","\\.net","\\.org","total deposits","total withdrawals","interest paid","fees charged","summary of account","account summary","card number","member number","sort code","swift code","bic code","thank you for banking","visit us at","po box","p\\.o\\. box","attn:","inc\\.","llc","ltd\\.","transaction id","reference no","authorization code","processed on","credit limit","credit line","cash limit","interest rate","available credit","closing balance","payments in","payments out","total","account number","for ","your branch","we find ways","tel ","swift code","hours a day","contact us by phone","bdo\\.com","laguna","philippines"],Ee=t=>{if(!t)return null;try{const e=t.trim().replace(/(\d+)(st|nd|rd|th)/,"$1");let n;if(/^\d{4}-\d{2}-\d{2}$/.test(e))n=new Date(e);else if(/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(e)){const s=e.split(/[-\/]/);n=new Date(`${s[2]}-${s[0]}-${s[1]}`),(isNaN(n.getTime())||parseInt(s[0],10)>12)&&(n=new Date(`${s[2]}-${s[1]}-${s[0]}`))}else if(/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?\s+\d{1,2}(?:,)?\s+\d{4}$/i.test(e))n=new Date(e);else if(/^\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?\s+\d{4}$/i.test(e))n=new Date(e);else if(/^\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?$/i.test(e)){const s=new Date().getFullYear();n=new Date(`${e} ${s}`)}else n=new Date(e);if(isNaN(n.getTime()))return null;const a=n.getFullYear(),o=String(n.getMonth()+1).padStart(2,"0"),r=String(n.getDate()).padStart(2,"0");return`${a}-${o}-${r}`}catch{return null}},ue={USD:"$",JPY:"Â¥",ILS:"â‚ª",PHP:"â‚±",EUR:"â‚¬"},te=Object.keys(ue),Fe=t=>{const e=t.toLowerCase();let n={};te.forEach(u=>n[u]=0);const a=e.match(/amount\s*\(([a-z]{3})\)/i);if(a&&te.includes(a[1].toUpperCase()))return a[1].toUpperCase();if([...e.matchAll(/[\d,]+\.?\d*\s*p\b/gi)].length>3)return"PHP";[...e.matchAll(/[$â‚¬Â£Â¥â‚¹â‚½â‚±â‚ª]/gi)].forEach(u=>{const p=u[0],d=Object.entries(ue).find(([m,g])=>g===p);d&&n[d[0]]++}),[...e.matchAll(/\b(USD|JPY|ILS|PHP|EUR)\b/gi)].forEach(u=>n[u[0].toUpperCase()]++);let i="USD",c=0;for(const[u,p]of Object.entries(n))p>c&&(c=p,i=u);return i},ne=t=>{if(!t)return null;let e=t.trim();e=e.replace(/[$â‚¬Â£Â¥â‚¹â‚½â‚±â‚ª]/gi,""),e=e.replace(/\s*P\s*$/i,"").trim(),e=e.replace(/(\d)\s+/g,"$1"),e=e.replace(/\s+(\d)/g,"$1"),e=e.replace(/[A-Za-z]/gi,"").trim();const n=(e.match(/\./g)||[]).length,a=(e.match(/,/g)||[]).length;if(a>0&&n>0){const r=e.lastIndexOf(",");e.lastIndexOf(".")>r?e=e.replace(/,/g,""):e=e.replace(/\./g,"").replace(",",".")}else if(a>0){const r=e.split(",");r.length===2&&r[1].length===2?e=e.replace(",","."):e=e.replace(/,/g,"")}else n>1&&(e=e.replace(/\./g,""));const o=parseFloat(e);return isNaN(o)?null:o},Be=t=>{const e={date:/\b(date|trans\.?\s*date|transaction\s*date)\b/i,description:/\b(description|details|particulars|transaction|narration)\b/i,withdrawal:/\b(withdrawal|withdrawals|debit|debits|payment|payments?\s*out)\b/i,deposit:/\b(deposit|deposits|credit|credits|payment\s*received|payments?\s*in)\b/i,balance:/\b(balance|running\s*balance)\b/i};let n=-1;for(let a=0;a<Math.min(15,t.length);a++){const r=t[a].toLowerCase(),s=e.date.test(r),i=e.description.test(r),c=e.withdrawal.test(r),u=e.deposit.test(r);if(s&&(i||c||u)){n=a;break}}return n!==-1?{headerLineIndex:n}:null},_e=t=>{const e=t.match(/^(January|February|March|April|May|June|July|August|September|October|November|December)\s+\d{1,2},?\s+\d{4}/i);let n=null,a=t;if(e)n=Ee(e[0]),a=t.substring(e[0].length).trim();else return{date:null};const o=a.split(/\t+|\s{2,}/);let r="",s=[];for(let d=0;d<o.length;d++){const m=o[d].trim();m&&(/[\d,.]/.test(m)&&ne(m)!==null?s.push(ne(m)):r||(r=m))}let i=null,c=null;s.length>=2&&(s.length===2?r.toLowerCase().includes("withdrawal")?i=s[0]:c=s[0]:s.length>=3&&(i=s[0],c=s.length>2?s[1]:null));let u=null,p=!1;return r.toLowerCase().includes("fund transfer")||r.toLowerCase().includes("deposit")?(u=c,p=!0):r.toLowerCase().includes("withdrawal")&&(u=i,p=!1),{date:n,description:r,transactionAmount:u,isDeposit:p}},ae=(t,e)=>{console.log("=== BDO Philippines Bank Statement Parser ===");const n=t.split(/\r?\n/).map(c=>c.trim()).filter(c=>c.length>0);console.log(`Total lines detected: ${n.length}`);const a=Fe(t);console.log("Detected Currency:",a);const o=Be(n);console.log(o?`âœ“ Found transaction table header at line ${o.headerLineIndex}`:"âš  No clear transaction table header found â€” attempting fallback parsing");let r=o?o.headerLineIndex+1:0,s=[],i=0;console.log(`
--- Beginning Transaction Parsing ---
`);for(let c=r;c<n.length;c++){const u=n[c],p=u.toLowerCase();if(Re.some(g=>new RegExp(`\\b${g}\\b`,"i").test(p))){i++;continue}if(p.includes("closing balance")||p.match(/\btotal\b/i)){i++;continue}const d=_e(u);if(!d.date){console.log(`âš  [Line ${c}] Skipped â€” invalid or missing date`);continue}if(!d.description||d.description.length<2){console.log(`âš  [Line ${c}] Skipped â€” missing or too short description`);continue}if(d.transactionAmount===null||d.transactionAmount===0){console.log(`âš  [Line ${c}] Skipped â€” invalid or zero amount`);continue}const m=d.isDeposit?Math.abs(d.transactionAmount):-Math.abs(d.transactionAmount);s.push({date:d.date,description:d.description.replace(/\s+/g," ").trim(),amount:m,currency:a,sourceFile:(e==null?void 0:e.name)||"unknown"}),console.log(`âœ“ [Line ${c}] Transaction added:`,{date:d.date,description:d.description.substring(0,40)+(d.description.length>40?"...":""),amount:m})}return s.sort((c,u)=>{const p=new Date(c.date),d=new Date(u.date);return isNaN(p.getTime())||isNaN(d.getTime())?0:p-d}),console.log(`
--- Parsing Summary ---`),console.log("Ignored Lines:",i),console.log("Transactions Parsed:",s.length),console.log(`=== Parsing Complete: ${s.length} transactions found ===
`),{formattedTransactions:s,summary:{},bankName:"BDO Philippines",fileCurrency:a,rawText:t}},J=t=>{if(!t)return null;const e=t.trim().replace(/,/g,""),n=parseFloat(e);return isNaN(n)?null:n},se=(t,e)=>{if(!t)return null;try{const n={jan:"01",feb:"02",mar:"03",apr:"04",may:"05",jun:"06",jul:"07",aug:"08",sep:"09",oct:"10",nov:"11",dec:"12"},a=t.toLowerCase().trim().split(/\s+/);if(a.length<2)return null;const o=a[0].padStart(2,"0"),r=a[1].substring(0,3),s=n[r];return s?`${e}-${s}-${o}`:null}catch{return null}},Ue=t=>{const e={},n={previousBalance:/Previous\s+Balance\s+([\d,]+\.?\d*)/i,paymentsAndCredits:/Payments?\s+(?:&|and)\s+Credits?\s+([\d,]+\.?\d*)/i,purchases:/Purchases\s+([\d,]+\.?\d*)/i,currentBalance:/Current\s+Balance\s+([\d,]+\.?\d*)/i};for(const[a,o]of Object.entries(n)){const r=t.match(o);r&&(e[a]=J(r[1]))}return e},Ke=t=>{const e={},n={totalDue:/Total\s+Due\s+([\d,]+\.?\d*)/i,minimumPayment:/Minimum\s+Payment\s+([\d,]+\.?\d*)/i,paymentDueDate:/Payment\s+Due\s+Date\s+(\d{1,2}\s+\w+\s+\d{4})/i};for(const[a,o]of Object.entries(n)){const r=t.match(o);r&&(a==="paymentDueDate"?e[a]=r[1]:e[a]=J(r[1]))}return e},Je=t=>{const e={},n={creditLimit:/Credit\s+Limit\s+(?:\(PHP\))?\s+([\d,]+\.?\d*)/i,availableCredit:/Available\s+Credit\s+(?:\(PHP\))?\s+([\d,]+\.?\d*)/i,cashLimit:/Cash\s+Limit\s+(?:\(PHP\))?\s+([\d,]+\.?\d*)/i};for(const[a,o]of Object.entries(n)){const r=t.match(o);r&&(e[a]=J(r[1]))}return e},He=t=>{const e=t.match(/Statement\s+from\s+\d{1,2}\s+\w+\s+(\d{4})/i);if(e)return parseInt(e[1],10);const n=t.match(/\b(20\d{2})\b/);return n?parseInt(n[1],10):new Date().getFullYear()},re=(t,e)=>{console.log("=== HSBC Philippines Credit Card Parser ===");const n=t.split(/\r?\n/).map(d=>d.trim()),a=Ue(t),o=Ke(t),r=Je(t),s=He(t);console.log("Statement Year:",s),console.log("Account Summary:",a),console.log("Payment Summary:",o),console.log("Credit Limit:",r);const i=[];let c=!1;const u=[/Previous\s+Statement\s+Balance/i,/ACCOUNT\s+SUMMARY/i,/PAYMENT\s+SUMMARY/i,/CREDIT\s+LIMIT/i,/INTEREST\s+RATES/i,/Total\s+Due/i,/Minimum\s+Payment/i,/Page\s+\d+\s+of\s+\d+/i,/CONTACT\s+US/i,/Customer\s+Service/i,/Continued\s+on\s+next\s+page/i,/HSBC\s+GOLD\s+VISA/i,/Card\s+Products/i,/The\s+Hongkong/i,/Makati\s+City/i,/Metro\s+Manila/i,/\d{4}[-\s]?X{4}[-\s]?X{4}[-\s]?\d{4}/i];for(let d=0;d<n.length;d++){const m=n[d];if(!m||m.length<5)continue;if(!c){const L=/POST\s+DATE\s+TRAN\s+DATE\s+DESCRIPTION\s+AMOUNT/i,B=/POST[\s\t]+TRAN/i,N=/DATE[\s\t]+DATE[\s\t]+DESCRIPTION[\s\t]+AMOUNT/i;if(L.test(m)||B.test(m)||N.test(m)){c=!0,console.log("âœ“ Found transaction table header at line",d);continue}}if(!c||u.some(L=>L.test(m)))continue;if(/^[\d,]+\.\d{2}$/.test(m)&&J(m)>5e4){console.log("âœ“ Reached end of transactions (Total Due line)");break}const g=/^(\d{1,2}\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec))\s+(\d{1,2}\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec))\s+(.+?)\s+([\d,]+\.\d{2})$/i,f=m.match(g);if(!f)continue;const h=f[1],C=f[2],S=f[3].trim(),v=f[4],A=se(h,s),k=se(C,s);if(!A){console.log("âš  Failed to parse date:",h);continue}const w=J(v);if(w===null||w===0){console.log("âš  Invalid amount:",v);continue}let x="PURCHASE",P=-w;const D=S.toLowerCase();(D.includes("payment")||D.includes("credit")||D.includes("reversal")||D.includes("refund")||D.includes("cashback"))&&(x="PAYMENT",P=w),i.push({date:A,transactionDate:k,description:S,amount:P,currency:"PHP",sourceFile:(e==null?void 0:e.name)||"unknown",type:x}),console.log("âœ“ Transaction added:",{date:A,description:S.substring(0,30)+"...",amount:P})}console.log(`
=== Parsing Complete: ${i.length} transactions found ===
`);const p={...a,...o,...r,statementYear:s};return{formattedTransactions:i,summary:p,accountSummary:a,paymentSummary:o,creditLimit:r,bankName:"HSBC Philippines",statementYear:s,rawText:t}},oe=(t,e)=>{console.log("=== HSBC UK Bank Statement Parser ===");const n=t.split(`
`).map(c=>c.trim()).filter(c=>c.length>0),a=ze(n);console.log("Detected format:",a);const o=Ze(n,t);console.log("Statement Period:",o);const r=qe(n);console.log("Account Summary:",r);const s=Ge(n);console.log("Account Details:",s);const i=a==="simple-table"?Ye(n,o.year):Ve(n,o.year);return console.log(`
=== Parsing Complete: ${i.length} transactions found ===`),{formattedTransactions:i,summary:r,accountSummary:r,accountDetails:s,statementPeriod:o,bankName:"HSBC UK",statementYear:o.year}},ze=t=>{for(const e of t){const n=e.toLowerCase();if(n.includes("withdrawals")&&n.includes("deposits")&&n.includes("balance")||n.includes("withdrawal")&&n.includes("deposit")||e.includes("Details of your account activity"))return"simple-table"}return"standard"},Ye=(t,e)=>{const n=[];let a=-1;for(let s=0;s<t.length;s++){const i=t[s].toLowerCase();if(i.includes("date")&&i.includes("description")||i.includes("details of your account activity")){a=s+1,console.log(`âœ“ Found simple table header at line ${s}: "${t[s]}"`);break}}if(a===-1)return console.log("âš  Could not find transaction table"),n;for(;a<t.length;){const s=t[a].toLowerCase();if(s.includes("withdrawal")||s.includes("deposit")||s.includes("balance")||s.includes("opening balance")||s==="date"||s==="description")console.log(`  Skipping header/opening line: "${t[a]}"`),a++;else break}let o=a,r=null;for(;o<t.length;){const s=t[o];if(console.log(`Line ${o}: "${s}"`),s.toLowerCase().includes("correspondence:")||s.toLowerCase().includes("statement page")||s.toLowerCase().includes("centenary square")||s.toLowerCase().includes("end of statement")||s.toLowerCase().includes("your closing balance")){console.log(`â¹ End of transaction section at line ${o}`);break}const i=s.match(/^(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)(\s+\d{2,4})?/i);if(i){r&&n.push(W(r));const c=i[1].padStart(2,"0"),u=i[2];let p=i[3]?i[3].trim():e;p.length===2&&(p=parseInt(p)>50?"19"+p:"20"+p),r={date:`${c} ${u} ${p}`,type:null,description:"",paidOut:null,paidIn:null,balance:null,rawLines:[s]},console.log(`
ðŸ“… New transaction: ${r.date}`);const d=s.substring(i[0].length).trim();d&&(r.description=d,console.log(`  Description: ${d}`))}else if(r){const c=s.match(/(\d+(?:,\d{3})*\.\d{2})/g);c&&c.length>0?We(s,r):s.trim()&&!s.match(/^(Withdrawals|Deposits|Balance)/i)&&(r.description?r.description+=" "+s.trim():r.description=s.trim(),console.log(`  Description extended: ${r.description}`))}o++}return r&&n.push(W(r)),console.log(`
âœ… Total transactions extracted: ${n.length}`),n},We=(t,e)=>{console.log(`  ðŸ’° Parsing amounts from: "${t}"`);const n=[],a=/(\d+(?:,\d{3})*\.\d{2})/g;let o;for(;(o=a.exec(t))!==null;){const r=o[1].replace(/,/g,"");n.push(parseFloat(r))}if(console.log(`     Found ${n.length} amounts:`,n),n.length!==0){if(n.length===3)n[0]>0&&(e.paidOut=n[0]),n[1]>0&&(e.paidIn=n[1]),e.balance=n[2];else if(n.length===2){e.balance=n[1];const r=(e.description||"").toLowerCase(),s=["transfer","interest paid","deposit","credit","payment received","refund"],i=["withdrawal","atm","cheque","purchase","payment","debit","fee"],c=s.some(p=>r.includes(p)),u=i.some(p=>r.includes(p));c&&!u?e.paidIn=n[0]:e.paidOut=n[0]}else n.length===1&&(e.paidOut===null&&e.paidIn,e.balance=n[0]);console.log(`     Assigned - PaidOut: ${e.paidOut}, PaidIn: ${e.paidIn}, Balance: ${e.balance}`)}},Ze=(t,e)=>{const n=/(\d{1,2})\s+([A-Za-z]+)\s+to\s+(\d{1,2})\s+([A-Za-z]+)\s+(\d{4})/i,a=/From[A-Za-z]{3}(\d{1,2}),(\d{4})to[A-Za-z]{3}(\d{1,2}),(\d{4})/i;for(const i of t){const c=i.match(n);if(c)return{startDay:c[1],startMonth:c[2],endDay:c[3],endMonth:c[4],year:c[5],fullText:c[0]};const u=i.match(a);if(u)return{startDay:u[1],startMonth:"",endDay:u[3],endMonth:"",year:u[4],fullText:i}}const o=/on\s+([A-Za-z]+)\s+(\d{1,2}),\s+(\d{4})/i;for(const i of t){const c=i.match(o);if(c)return{startDay:c[2],startMonth:c[1],endDay:"",endMonth:"",year:c[3],fullText:c[0]}}const r=e.match(/\b(20\d{2})\b/);return{startDay:"",startMonth:"",endDay:"",endMonth:"",year:r?r[1]:new Date().getFullYear().toString(),fullText:""}},qe=t=>{const e={openingBalance:null,paymentsIn:null,paymentsOut:null,closingBalance:null};for(let n=0;n<t.length;n++){const a=t[n],o=n+1<t.length?t[n+1]:"";if(a.toLowerCase().includes("opening balance")){const r=E(a)||E(o);r!==null&&(e.openingBalance=r)}else if(a.toLowerCase().includes("total deposits into your account")){const r=E(a)||E(o);r!==null&&(e.paymentsIn=r)}else if(a.toLowerCase().includes("total withdrawals from your account")){const r=E(a)||E(o);r!==null&&(e.paymentsOut=r)}else if(a.toLowerCase().includes("closing balance")){const r=E(a)||E(o);r!==null&&(e.closingBalance=r)}else if(a.toLowerCase().includes("payments in")){const r=E(o)||E(a);r!==null&&(e.paymentsIn=r)}else if(a.toLowerCase().includes("payments out")){const r=E(o)||E(a);r!==null&&(e.paymentsOut=r)}}return e},Ge=t=>{const e={accountName:null,iban:null,bic:null,sortCode:null,accountNumber:null};for(let n=0;n<t.length;n++){const a=t[n];a.match(/^GB\d{2}[A-Z]{4}\d+$/)&&(e.iban=a),a.match(/^[A-Z]{4}GB[A-Z0-9]+$/)&&(e.bic=a);const o=a.match(/(\d{2}[-]\d{2}[-]\d{2})/);o&&(e.sortCode=o[1]);const r=a.match(/account number:\s*(\d{8})/i);if(r)e.accountNumber=r[1];else{const s=a.match(/\b(\d{8})\b/);s&&!e.accountNumber&&(e.accountNumber=s[1])}if(a.match(/^[A-Z\s]{3,50}$/)&&!a.match(/HSBC|LONDON|STREET|ACCOUNT|BALANCE|STATEMENT/i)&&!e.accountName&&n>0&&t[n-1].includes("HSBC")&&(e.accountName=a),a.toLowerCase().includes("account name")){const s=n+1<t.length?t[n+1]:"";s&&!s.match(/^\d/)&&s.length<50&&(e.accountName=s)}}return e},Ve=(t,e)=>{const n=[],a=["BP","CR","DD","SO","CHQ","ATM","TFR","FEE","INT","BAC","FPI","Debit","Credit"];let o=-1;for(let i=0;i<t.length;i++){const c=t[i].toLowerCase();if(c.includes("paid out")&&c.includes("paid in")||c.includes("money out")&&c.includes("money in")||c.includes("payment type")&&c.includes("details")||c==="transactions"){o=i+1,console.log(`âœ“ Found transaction table header at line ${i}: "${t[i]}"`);break}}if(o===-1){console.log("âš  Could not find transaction section start");for(let i=0;i<t.length;i++)if(t[i].toLowerCase().includes("transaction")){console.log(`Found "transactions" keyword at line ${i}, searching for first date...`),o=i+1;break}}if(o===-1)return console.log("âš  Still could not find start, aborting"),n;let r=o,s=null;for(;r<t.length&&(t[r].toLowerCase().includes("description")||t[r].toLowerCase().includes("continued")||t[r].toLowerCase().includes("details")||t[r].toLowerCase().includes("money")||t[r].toLowerCase().includes("balance")||t[r].toLowerCase()==="date");)console.log(`  Skipping header line: "${t[r]}"`),r++;for(;r<t.length;){const i=t[r];if(console.log(`Line ${r}: "${i}"`),i.toLowerCase().includes("balance carried forward")||i.toLowerCase().includes("continued on next page")||i.toLowerCase().includes("correspondence:")||i.toLowerCase().includes("statement page")||i.toLowerCase().includes("centenary square")||i.match(/^\d+\s+(High Street|Centenary Square)/)){console.log(`â¹ End of transaction section at line ${r}`);break}if(i.toUpperCase().includes("BALANCE BROUGHT FORWARD")||i.toUpperCase().includes("BALANCE B/F")||i.toUpperCase().includes("CLOSING BALANCE")){r++;continue}const c=i.match(/^(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d{2,4})/i);if(c){s&&n.push(W(s));const u=c[1].padStart(2,"0"),p=c[2],d=c[3],m=d.length===2?parseInt(d)>50?"19"+d:"20"+d:d;s={date:`${u} ${p} ${m}`,type:null,description:"",paidOut:null,paidIn:null,balance:null,rawLines:[i]},console.log(`
ðŸ“… New transaction started: ${s.date}`);const g=i.substring(c[0].length).trim();if(g){const f=g.match(/(\d+(?:,\d{3})*\.\d{2})/g);if(f){const h=g.indexOf(f[0]),C=g.substring(0,h).trim();C&&(s.description=C,console.log(`  Description (from same line): ${C}`)),ie(g,s)}else s.description=g,console.log(`  Description (from same line): ${g}`)}}else s&&(s.rawLines.push(i),!s.type&&a.includes(i.trim())?(s.type=i.trim(),console.log(`  Type: ${s.type}`)):i.match(/\d+\.\d{2}/)?ie(i,s):i.trim()&&!i.match(/^[\d,]+\.?\d*$/)&&i.trim().length>1&&(["continued","details","out","in","balance"].includes(i.trim().toLowerCase())||(s.description?s.description+=" "+i.trim():s.description=i.trim(),console.log(`  Description: ${s.description}`))));r++}return s&&n.push(W(s)),console.log(`
âœ… Total transactions extracted: ${n.length}`),n},ie=(t,e)=>{console.log(`  ðŸ’° Parsing amounts from: "${t}"`);const n=[],a=/(\d+(?:,\d{3})*\.\d{2})/g;let o;for(;(o=a.exec(t))!==null;){const r=o[1].replace(/,/g,"");n.push(parseFloat(r))}console.log(`     Found ${n.length} amounts:`,n),n.length!==0&&(n.length>=3?(n[0]>0&&(e.paidOut=n[0]),n[1]>0&&(e.paidIn=n[1]),e.balance=n[2]):n.length===2?(e.type==="CR"||e.paidOut!==null?e.paidIn=n[0]:e.paidOut=n[0],e.balance=n[1]):n.length===1&&(e.paidOut!==null||e.paidIn!==null?e.balance=n[0]:e.type==="CR"?e.paidIn=n[0]:e.paidOut=n[0]),console.log(`     Assigned - PaidOut: ${e.paidOut}, PaidIn: ${e.paidIn}, Balance: ${e.balance}`))},W=t=>{let e=0,n="debit";t.paidIn!==null&&t.paidIn>0?(e=t.paidIn,n="credit"):t.paidOut!==null&&t.paidOut>0&&(e=-t.paidOut,n="debit");const a={date:t.date,type:t.type||"UNKNOWN",description:Xe(t.description),amount:e,debit:t.paidOut,credit:t.paidIn,balance:t.balance,transactionType:n,category:Qe(t.type,t.description)};return console.log(`âœ“ Finalized: ${a.date} | ${a.type} | ${a.description} | Amount: ${a.amount}`),a},Xe=t=>t?(t=t.replace(/\s+/g," ").trim(),t=t.replace(/[|]/g,""),t):"",Qe=(t,e)=>{const n=(e||"").toLowerCase();switch(t){case"BP":return"Bill Payment";case"CR":return"Credit/Deposit";case"DD":return"Direct Debit";case"SO":return"Standing Order";case"CHQ":return"Cheque";case"ATM":return"ATM Withdrawal";case"TFR":return"Transfer";case"FEE":return"Fee";case"INT":return"Interest";case"BAC":return"BACS Payment";case"FPI":return"Faster Payment";default:return n.includes("salary")||n.includes("wages")?"Income":n.includes("transfer")?"Transfer":n.includes("deposit")?"Deposit":n.includes("rent")?"Rent":n.includes("groceries")||n.includes("supermarket")?"Groceries":n.includes("restaurant")||n.includes("cafe")||n.includes("coffee")?"Dining":n.includes("gas")||n.includes("electric")||n.includes("water")?"Utilities":n.includes("uber")||n.includes("taxi")?"Transport":"Other"}},E=t=>{const e=t.match(/(\d+(?:,\d{3})*\.\d{2})/);return e?parseFloat(e[1].replace(/,/g,"")):null},ce=(t,e)=>{const n=[],a=t.split(`
`).map(m=>m.trim()).filter(Boolean);let o=null;const r=t.match(/(20\d{2})/);r&&(o=r[1]);try{if(typeof ignoreWords<"u"&&Array.isArray(ignoreWords)){const m=ignoreWords.findIndex(g=>/previous\s*balance/i.test(String(g)));m!==-1&&ignoreWords.splice(m,1)}}catch{}const s=m=>{if(m===null||typeof m>"u"||m==="")return 0;const g=String(m).replace(/\(([^)]+)\)/g,(h,C)=>`-${C}`).replace(/[^0-9\.\-\,]/g,"").replace(/,/g,""),f=parseFloat(g);return Number.isFinite(f)?f:0},i=[/previous\s+balance[:\s]*([-\d,().,]+)/i,/balance\s+brought\s+forward[:\s]*([-\d,().,]+)/i,/opening\s+balance[:\s]*([-\d,().,]+)/i,/opening[:\s]*balance[:\s]*([-\d,().,]+)/i];for(const m of i){const g=t.match(m);if(g&&g[1]){const f=s(g[1]);!n.some(C=>/previous\s*balance/i.test(C.description||"")||C.category==="opening_balance")&&f!==0&&n.unshift({date:`${o||new Date().getFullYear()}-03-02`,description:"Previous balance",amount:f,category:"opening_balance",currency:"PHP",sourceFile:(e==null?void 0:e.name)||"Metrobank Statement"});break}}for(let m=0;m<a.length;m++){const f=a[m].split(/\s{2,}|\t+/).map(w=>w.trim()).filter(Boolean);if(f.length<3)continue;let h=null;for(const w of[/^\d{1,2}[\/\-]\d{1,2}(?:[\/\-]\d{2,4})?/,/^\d{1,2}\s+[A-Za-z]{3,9}\s+\d{2,4}/,/^\d{1,2}\s+[A-Za-z]{3,9}/])if(f[0].match(w)){h=f[0];break}if(!h)continue;let C=f[1],S=f[2]&&f[2]!=="-"?parseFloat(f[2].replace(/,/g,"")):0,v=f[3]&&f[3]!=="-"?parseFloat(f[3].replace(/,/g,"")):0,A=S?-Math.abs(S):v;if(/check|deposit|payment/i.test(C)&&(A=Math.abs(v||S)),/water bill|rent bill|payroll|main office wholesale|debit transaction/i.test(C)&&(A=-Math.abs(S||v)),/previous balance/i.test(C))continue;const k=w=>{const x=w.split(/[\/\-]/);if(x.length===3){let[P,D,L]=x;return L.length===2&&(L=`20${L}`),P.length===1&&(P=`0${P}`),D.length===1&&(D=`0${D}`),`${L}-${P}-${D}`}return w};n.push({date:k(h),description:C,amount:A,currency:"PHP",sourceFile:(e==null?void 0:e.name)||"Metrobank Statement"})}const c=t.match(/opening\s+balance[:\s]*([-\d,().,]+)\b/i),u=t.match(/closing\s+balance[:\s]*([-\d,().,]+)\b/i),p={openingBalance:c?s(c[1]):null,closingBalance:u?s(u[1]):null};return n.length===0&&console.warn("Metrobank parser: no transactions detected in primary passes. Raw text sample:",t.slice(0,200)),{formattedTransactions:n.map(m=>({...m,date:m.date||null})),summary:p,bankName:"METROBANK"}},le=(t,e={})=>{console.log("=== Landbank Statement Parser ===");const n=t.split(`
`).map(h=>h.trim()).filter(h=>h.length>0),a=[],o=t.match(/(20\d{2})/),r=o?o[1]:new Date().getFullYear().toString(),s=/^(\d{2}\/\d{2}\/\d{2,4}|\d{2}-\d{2}-\d{2,4}|\d{2}\s+[A-Za-z]{3}\s+\d{2,4})/i,i=/([\d,]+\.\d{2})/,c=[/page\s+\d+\s+of\s+\d+/i,/land\s*bank\s*of\s*the\s*philippines/i,/statement\s+of\s+account/i,/account\s+number/i,/branch:/i,/date\s+printed/i,/transaction\s+history/i,/currency:\s*php/i],u=h=>{if(!h)return null;const C=h.includes("(")||h.includes("-"),S=h.replace(/[(),\s]/g,""),v=parseFloat(S);return isNaN(v)?null:C?-v:v},p=h=>{if(!h)return null;try{const C=h.match(/(\d{2})[\/-](\d{2})[\/-](\d{2,4})/);if(C){const[A,k,w,x]=C;return`${x.length===2?"20"+x:x}-${w}-${k}`}const S={JAN:"01",FEB:"02",MAR:"03",APR:"04",MAY:"05",JUN:"06",JUL:"07",AUG:"08",SEP:"09",OCT:"10",NOV:"11",DEC:"12"},v=h.match(/(\d{2})\s+([A-Za-z]{3})\s+(\d{2,4})/i);if(v){const[A,k,w,x]=v,P=S[w.toUpperCase()];return`${x.length===2?"20"+x:x}-${P}-${k}`}}catch(C){console.warn("Date parsing failed:",C)}return null},d=h=>[/transfer from banknet/i,/visa transfer from/i,/cash-?in from pay\s?&?\s?go/i].some(S=>S.test(h))?1:-1;for(let h=0;h<n.length;h++){const C=n[h].trim();if(!C||c.some(x=>x.test(C)))continue;const S=C.match(s);if(!S)continue;const v=S[0];let A=C.replace(v,"").trim();const k=A.match(new RegExp(i,"g"))||[];if(k.length===0)continue;let w=null;if(k.length>=2){const x=k[k.length-2];w=u(x),A=A.replace(new RegExp(i,"g"),"").trim()}else w=u(k[0]),A=A.replace(i,"").trim();if(w!==null){const x=d(A),P={date:p(v),description:A||"UNKNOWN TRANSACTION",amount:Math.abs(w)*x,currency:"PHP",sourceFile:(e==null?void 0:e.name)||"Landbank Statement"},D=G.categorizeTransaction(P.description,P.amount),L=G.correctTransaction(P);a.push({...L,category:D,category_confidence:G.getConfidence(P.description,D)})}}const m={openingBalance:null,closingBalance:null,totalCredits:0,totalDebits:0},g=t.match(/(?:opening|previous|beginning)\s+balance\s*:?\s*([\d,]+\.\d{2})/i),f=t.match(/(?:closing|ending)\s+balance\s*:?\s*([\d,]+\.\d{2})/i);return m.openingBalance=g?u(g[1]):null,m.closingBalance=f?u(f[1]):null,a.forEach(h=>{h.amount>0?m.totalCredits+=h.amount:m.totalDebits+=Math.abs(h.amount)}),console.log(`
=== Parsing Complete: ${a.length} transactions found ===
`),{formattedTransactions:a,summary:m,bankName:"LANDBANK",statementYear:r}};let Y=null;const et=async()=>{if(Y)return Y;try{const{data:t,error:e}=await ye.functions.invoke("get-ocr-api-key");if(e)throw new Error(`Failed to fetch OCR API key: ${e.message}`);if(!t||!t.apiKey)throw new Error("OCR API key was not returned from the server.");return Y=t.apiKey,Y}catch(t){throw console.error("Exception fetching OCR API key:",t),t}},tt=t=>{const e=t.toLowerCase();return e.includes("hsbc")?"HSBC":e.includes("bdo unibank")||e.includes("banco de oro")||e.includes("transaction date")&&e.includes("value date")?"BDO":e.includes("bank of the philippine islands")||e.includes("bpi")||e.includes("bpi family savings bank")?"BPI":e.includes("metrobank")||e.includes("metropolitan bank")||e.includes("metro bank")?"METROBANK":e.includes("land bank")||e.includes("landbank")||e.includes("land bank of the philippines")?"LANDBANK":e.includes("security bank")?"SECURITY_BANK":e.includes("citibank")||e.includes("citi")?"CITIBANK":"UNKNOWN"},de=t=>{const e=t.toLowerCase(),n=[e.includes("paid out")&&e.includes("paid in"),e.includes("payments out")&&e.includes("payments in"),e.includes("your statement"),e.includes("sort code")||e.includes("sortcode"),/international bank account number/i.test(t),/branch identifier code/i.test(t),/\d{2}[-]\d{2}[-]\d{2}/.test(t),/balance brought forward/i.test(t),/balance carried forward/i.test(t)],a=[e.includes("credit card statement"),e.includes("post date")&&e.includes("tran date"),e.includes("hsbc gold visa"),e.includes("credit limit"),e.includes("minimum amount due"),e.includes("payment due date"),e.includes("previous balance")&&e.includes("new balance"),/available credit/i.test(t)],o=n.filter(Boolean).length,r=a.filter(Boolean).length;return console.log("HSBC Type Detection - UK Score:",o,"| Philippines Score:",r),o>r&&o>=2?"UK_BANK_STATEMENT":r>o&&r>=2?"PHILIPPINES_CREDIT_CARD":e.includes("paid out")||e.includes("paid in")?"UK_BANK_STATEMENT":e.includes("credit card statement")||e.includes("minimum amount due")?"PHILIPPINES_CREDIT_CARD":"UNKNOWN"},nt=async(t,e,n)=>{var s;const{rawText:a,formattedTransactions:o,detectedBank:r}=n;if(o&&o.length>5)return console.log("âœ… Initial OCR successful, skipping recovery"),n;console.log("ðŸ”„ Performing AI-enhanced recovery...");try{const i=new FormData;i.append("file",t),i.append("apikey",e),i.append("language","eng"),i.append("isOverlayRequired","true"),i.append("detectOrientation","true"),i.append("scale","true"),i.append("OCREngine","2"),i.append("isTable","true");const c=await fetch("https://api.ocr.space/parse/image",{method:"POST",body:i});if(!c.ok)return console.warn("Enhanced OCR failed, using original results"),n;const u=await c.json();if(u.ParsedResults&&((s=u.ParsedResults[0])!=null&&s.ParsedText)){const p=u.ParsedResults[0].ParsedText,d=pe(p,r,t),m=at(o,d.formattedTransactions);return console.log(`ðŸ”„ Recovery found ${m.length-o.length} additional transactions`),{...n,formattedTransactions:m,recoveryPerformed:!0,originalCount:o.length,recoveredCount:m.length-o.length}}}catch(i){console.error("Recovery failed:",i)}return n},at=(t,e)=>{if(!e||e.length===0)return t;if(!t||t.length===0)return e;const n=[...t];for(const a of e)t.some(r=>st(r,a))||n.push({...a,recovered:!0,confidence:.7});return n.sort((a,o)=>!a.date||!o.date?0:new Date(a.date)-new Date(o.date))},st=(t,e)=>!!(t.date===e.date&&Math.abs((t.amount||0)-(e.amount||0))<.02||t.description&&e.description&&rt(t.description.toLowerCase(),e.description.toLowerCase())>.8),rt=(t,e)=>{if(!t||!e)return 0;const n=t.length>e.length?t:e,a=t.length>e.length?e:t;if(n.length===0)return 1;const o=ot(n,a);return(n.length-o)/n.length},ot=(t,e)=>{const n=[];for(let a=0;a<=e.length;a++)n[a]=[a];for(let a=0;a<=t.length;a++)n[0][a]=a;for(let a=1;a<=e.length;a++)for(let o=1;o<=t.length;o++)e.charAt(a-1)===t.charAt(o-1)?n[a][o]=n[a-1][o-1]:n[a][o]=Math.min(n[a-1][o-1]+1,n[a][o-1]+1,n[a-1][o]+1);return n[e.length][t.length]},me=(t="")=>{const e=(t||"").toLowerCase();return/account statement|bank statement|statement period|statement date/i.test(e)||/opening balance|closing balance|beginning balance|ending balance/i.test(e)||/transaction history|account activity|account summary/i.test(e)||/bdo|hsbc|metrobank|landbank|bpi|security bank|citibank/i.test(e)||/(date|description|amount|balance).+(date|description|amount|balance)/i.test(e)},it=(t="")=>{const e=(t||"").toLowerCase();return[/(?:store\s+)?receipt|sales slip|tax invoice/i,/(?:sub-?total|tax|amount|balance).+total/i,/(?:cashier|terminal|register|store)\s+#?\d/i,/qty|@|each|item|price.+\$?\d+\.\d{2}/i,/thank you|please come again|come again/i,/card\s+(?:auth|number|type)|approved/i].filter(o=>o.test(e)).length>=2&&!me(e)&&e.length<2e3},pe=(t="",e="UNKNOWN",n={})=>{if(!t)return{formattedTransactions:[],summary:{},rawText:""};if(me(t))switch((e||"").toUpperCase()){case"BDO":try{return ae(t,n)}catch(a){console.warn("BDO parse failed",a)}break;case"HSBC":{if(de(t)==="UK_BANK_STATEMENT")try{return oe(t,n)}catch(o){console.warn("HSBC UK parse failed",o)}try{return re(t,n)}catch(o){console.warn("HSBC PH parse failed",o)}break}case"METROBANK":try{return ce(t,n)}catch(a){console.warn("Metrobank parse failed",a)}break;case"LANDBANK":try{return le(t,n)}catch(a){console.warn("Landbank parse failed",a)}break}if(it(t))return parseReceiptFromText(t,n);switch((e||"").toUpperCase()){case"BDO":return ae(t,n);case"HSBC":return de(t)==="UK_BANK_STATEMENT"?oe(t):re(t,n);case"METROBANK":return ce(t,n);case"LANDBANK":return le(t,n);default:return{formattedTransactions:[],summary:{},rawText:t}}},ct=async(t,e,n=!0)=>{var r,s,i;let a;try{a=await et()}catch(c){const u=`OCR functionality is disabled. Failed to retrieve API key: ${c.message}`;return{rawText:u,formattedTransactions:[],error:u,detectedBank:"UNKNOWN",summary:{}}}if(!a){const c="OCR functionality is disabled. API key could not be retrieved.";return{rawText:c,formattedTransactions:[],error:c,detectedBank:"UNKNOWN",summary:{}}}const o=new FormData;o.append("file",t),o.append("apikey",a),o.append("language","eng"),o.append("isOverlayRequired","false"),o.append("detectOrientation","true"),o.append("scale","true"),o.append("OCREngine","2"),o.append("isTable","true");try{console.log("ðŸ” PASS 1: Standard OCR extraction...");const c=await fetch("https://api.ocr.space/parse/image",{method:"POST",body:o});if(!c.ok){const p=await c.json().catch(()=>({ErrorMessage:["Failed to parse error response from OCR API."]}));let d=`OCR API request failed with status ${c.status}.`;return((r=p==null?void 0:p.ErrorMessage)==null?void 0:r.length)>0&&(d+=` Details: ${p.ErrorMessage.join(", ")}`),{rawText:d,formattedTransactions:[],error:d,detectedBank:"UNKNOWN",summary:{}}}const u=await c.json();if(u.IsErroredOnProcessing){const p=((s=u.ErrorMessage)==null?void 0:s.join(", "))||"Unknown processing error";return{rawText:`OCR processing error: ${p}`,formattedTransactions:[],error:`OCR processing error: ${p}`,detectedBank:"UNKNOWN",summary:{}}}if(u.ParsedResults&&((i=u.ParsedResults[0])!=null&&i.ParsedText)){const p=u.ParsedResults[0].ParsedText,d=e||tt(p);let m=null,g;try{g=pe(p,d,t)}catch(h){console.error("parseWithBankParser failed, falling back to empty parseResult:",h),g={formattedTransactions:[],summary:{}}}console.log(`ðŸ“Š PASS 1 Results: ${((g==null?void 0:g.formattedTransactions)||[]).length} transactions found`);let f={rawText:p,formattedTransactions:g.formattedTransactions||[],detectedBank:d,summary:g.summary||{},recoveryPerformed:!1,originalCount:(g.formattedTransactions||[]).length};if(n)try{const h=await nt(t,a,{rawText:p,formattedTransactions:f.formattedTransactions,detectedBank:d,summary:f.summary});h&&h.formattedTransactions&&(f={...f,formattedTransactions:h.formattedTransactions,recoveryPerformed:h.recoveryPerformed||!0,recoveredCount:(h.formattedTransactions||[]).length-f.originalCount,summary:h.summary||f.summary})}catch(h){console.warn("AI recovery step failed:",h)}return f}return{rawText:"",formattedTransactions:[],detectedBank:"UNKNOWN",summary:{}}}catch(c){return console.error("OCR request failed:",c),{rawText:"",formattedTransactions:[],error:c.message||String(c),detectedBank:"UNKNOWN",summary:{}}}},lt="http://localhost:8000";function dt(t){var r;const e=typeof t.amount=="string"?parseFloat(t.amount):t.amount,n=e<0?"expense":"income";let a="other";const o=((r=t.description)==null?void 0:r.toLowerCase())||"";return o.includes("transfer")&&(a="transfer"),(o.includes("withdrawal")||o.includes("atm"))&&(a="withdrawal"),{date:t.date||"",description:t.description||"",amount:Math.abs(e),type:n,category:a}}async function K(t,e){try{const n=t.map(dt),a=await fetch(`${lt}/api/insights`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transactions:n,feature:e,...e==="weekly_report"&&{days:28}})});if(!a.ok){const o=await a.json();throw new Error(o.detail||"Failed to get insights")}return await a.json()}catch(n){throw console.error("AI Insights API Error:",n),n.message?new Error(n.message):n}}const ut="http://localhost:8000",mt={EXPENSE_SUMMARY:"expense_summary",CASH_FLOW:"cash_flow_forecast",UNUSUAL_TRANSACTIONS:"flag_unusual_transactions",WEEKLY_REPORT:"weekly_report",COMBINED:"combined_insights"},V=10,he=5,pt=he*1024*1024,ht=()=>l.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-8 rounded-md shadow-md dark:bg-[hsl(var(--boogasi-yellow))]/20 dark:text-[hsl(var(--brighter-yellow-text))] dark:border-[hsl(var(--boogasi-yellow))]",role:"alert",children:l.jsxs("div",{className:"flex items-center",children:[l.jsx(Oe,{className:"h-6 w-6 mr-3"}),l.jsx("p",{className:"font-bold",children:"âš ï¸ This tool is for research purposes only. Boogasi does not provide financial advice. Learn more below."})]})}),Tt=()=>{const{toast:t}=be(),{user:e}=Ce(),[n,a]=j.useState([]),[o,r]=j.useState(""),[s,i]=j.useState(null);j.useState("");const[c,u]=j.useState({}),[p,d]=j.useState(!1),[m,g]=j.useState(""),[f,h]=j.useState("Valued User"),[C,S]=j.useState(!1),[v,A]=j.useState(null);j.useEffect(()=>{e&&e.user_metadata&&h(e.user_metadata.name||e.user_metadata.screen_name||"Valued User")},[e]);const k=".csv, .pdf, .png, .jpeg, .jpg",w=["text/csv","application/pdf","image/png","image/jpeg"],x=j.useCallback(async N=>{const R=Array.from(N.target.files);let M=n.length;const O=[];for(const y of R){if(M>=V){t({variant:"destructive",title:"File Limit Reached",description:`Maximum of ${V} files allowed.`});break}if(!w.includes(y.type)&&!k.split(", ").some(b=>y.name.toLowerCase().endsWith(b))){t({variant:"destructive",title:"Invalid file type",description:`File "${y.name}" is not a valid type.`});continue}if(y.size>pt){t({variant:"destructive",title:"File Too Large",description:`File "${y.name}" exceeds ${he}MB limit.`});continue}O.push(y),M++}if(O.length===0){N.target&&(N.target.value=null);return}S(!0),g(`Processing ${O.length} file(s)... AI enhancement will be enabled.`),d(!0),g(`Processing ${O.length} file(s)... This may take a moment.`);const I=[];let _=0;try{for(const y of O){let b={file:y,rawText:null,formattedTransactions:[],error:null};if(y.type.startsWith("image/")||y.type==="application/pdf"){_++,g(`Boogasi AI is performing OCR & parsing transactions for ${y.name}...`);try{const{rawText:T,formattedTransactions:$,error:F}=await ct(y);b.rawText=T,b.formattedTransactions=$||[],b.error=F,u(q=>({...q,[y.name]:{rawText:T,formattedTransactions:$||[],error:F}}));let H="OCR & Parsing Attempted by Boogasi AI.";F?H=`OCR Error: ${F}`:H=`Text extracted. Found ${$?$.length:0} potential transactions. Review results.`,t({title:`Processed: ${y.name}`,description:H,duration:7e3})}catch(T){console.error(`OCR & Parsing failed for ${y.name}:`,T);const $=`OCR Error for ${y.name}: ${T.message}`;t({variant:"destructive",title:"OCR & Parsing Failed",description:$,duration:7e3}),u(F=>({...F,[y.name]:{rawText:$,formattedTransactions:[],error:$}})),b.rawText=$,b.error=$}}I.push(b.file)}if(I.length>0){a(T=>[...T,...I].slice(0,V));const y=`${I.length} file(s) processed.`,b=_>0?` OCR & transaction parsing attempted by Boogasi AI on ${_} image/PDF file(s).`:"";t({title:"File Processing Complete",description:y+b+" ðŸ¤– AI enhancement enabled!",duration:5e3})}}catch(y){console.error("Error during file processing loop:",y),t({variant:"destructive",title:"File Processing Error",description:"An unexpected error occurred while processing files.",duration:7e3})}finally{d(!1),g(""),N.target&&(N.target.value=null)}},[n,t,w,k]),P=j.useCallback(N=>{var M;const R=(M=n[N])==null?void 0:M.name;a(O=>O.filter((I,_)=>_!==N)),R&&u(O=>{const I={...O};return delete I[R],I}),t({title:"File Removed",description:`"${R}" has been removed.`})},[n,t]),D=async(N,R)=>{try{const M=await fetch(`${ut}/api/insights`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transactions:N,feature:R})});if(!M.ok){const O=await M.json();throw new Error(O.detail||"Failed to get insights")}return await M.json()}catch(M){throw console.error("AI Insights Error:",M),A(M.message),M}},L=async()=>{d(!0),A(null);try{const N=(c==null?void 0:c.transactions)||[],R=await D(N,mt.COMBINED);i(JSON.stringify(R,null,2)),t({title:"Analysis Complete",description:"AI insights are ready to view"})}catch(N){t({variant:"destructive",title:"Analysis Failed",description:N.message})}finally{d(!1)}},B=async N=>{var R,M;d(!0),g("Analyzing your data...");try{const I={"Analyze Expenses":"expense_summary","Forecast Cash Flow":"cash_flow_forecast","Flag Unusual Transactions":"flag_unusual_transactions","Generate Weekly Report":"weekly_report","Combined Analysis":"combined_insights"}[N];if(!I)throw new Error(`Unknown action: ${N}`);const y=Object.values(c||{}).flatMap(b=>(b==null?void 0:b.formattedTransactions)||[]).filter(b=>b&&(b.date||b.description)&&typeof b.amount<"u").map(b=>{let T=typeof b.amount=="string"?parseFloat(b.amount.replace(/[,â‚±\s]/g,"")):Number(b.amount||0);b.type==="expense"&&T>0&&(T=-T),b.type==="income"&&T<0&&(T=Math.abs(T));const $=b.type||(T<0?"expense":"income");return{...b,amount:Number.isNaN(T)?0:T,type:$,category:b.category||b.description||"other"}});if(console.log("[AI] Normalized transactions:",y.slice(0,3)),I==="combined_insights"){g("Running all analyses... This may take a moment.");const[b,T,$,F]=await Promise.all([K(y,"expense_summary"),K(y,"cash_flow_forecast"),K(y,"flag_unusual_transactions"),K(y,"weekly_report")]),q={feature:"combined_insights",data:{feature:"combined_insights",generated_at:new Date().toISOString(),summary:{total_transactions:y.length,date_range:{start:(R=y[0])==null?void 0:R.date,end:(M=y[y.length-1])==null?void 0:M.date}},detailed_analyses:{expense_summary:b,cash_flow_forecast:T,flagged_transactions:$,weekly_report:F}},transactions:y};i(q),t({title:"Combined Analysis Complete",description:"All financial analyses have been generated."})}else{const b=await K(y,I);i({feature:I,data:b,transactions:y}),t({title:"Analysis Complete",description:`AI insights for "${N}" are ready.`})}}catch(O){console.error("Error during AI analysis:",O),t({variant:"destructive",title:"Analysis Failed",description:O.message||"An unexpected error occurred"})}finally{d(!1),g("")}};return l.jsxs("div",{className:"container mx-auto px-4 py-8",children:[l.jsx(ht,{}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[l.jsxs("div",{className:"space-y-6",children:[l.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 shadow-md",children:[l.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Transaction Analysis"}),l.jsxs("div",{className:"mb-6",children:[l.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Upload Bank Statements"}),l.jsx(Le,{onChange:x,onRemove:P,files:n,acceptedTypes:k})]}),l.jsxs("div",{className:"mb-6",children:[l.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Manual Transaction Input"}),l.jsx("textarea",{className:"w-full h-32 p-2 border rounded",value:o,onChange:N=>r(N.target.value),placeholder:"Paste transactions here (e.g., Date,Description,Category,Amount)..."})]}),l.jsx(X,{onClick:L,disabled:p||!n.length&&!o,children:"Analyze Transactions"})]}),l.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 shadow-md",children:[l.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Portfolio Tools"}),l.jsxs("div",{className:"space-y-4",children:[l.jsx(U,{icon:l.jsx(ke,{className:"h-5 w-5"}),title:"Track Contributions",onClick:()=>B("track_contributions")}),l.jsx(U,{icon:l.jsx(De,{className:"h-5 w-5"}),title:"Rebalance Reminders",onClick:()=>B("rebalance_reminder")}),l.jsx(U,{icon:l.jsx(Ie,{className:"h-5 w-5"}),title:"Portfolio Performance Report",onClick:()=>B("performance_report")}),l.jsx(U,{icon:l.jsx(je,{className:"h-5 w-5"}),title:"Goal Progress Tracking",onClick:()=>B("goal_tracking")}),l.jsx(U,{icon:l.jsx($e,{className:"h-5 w-5"}),title:"Smart Portfolio Alerts",onClick:()=>B("portfolio_alerts")})]})]})]}),l.jsxs("div",{className:"space-y-6",children:[l.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4",children:[l.jsxs("div",{className:"flex items-center space-x-2",children:[l.jsx(Me,{className:"h-5 w-5 text-blue-500"}),l.jsx("span",{children:"AI Enhancement (Active)"})]}),l.jsx("p",{className:"text-sm mt-1 text-gray-600 dark:text-gray-400",children:"Auto-enabled with uploaded files â€¢ Trained on 5+ bank statements"})]}),s&&l.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 shadow-md",children:[l.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Analysis Results"}),l.jsxs("div",{className:"mb-8",children:[l.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Overall Cash Flow"}),l.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[l.jsx(CashFlowPieChart,{data:s.cashFlow}),l.jsx(CashFlowSummary,{data:s.summary})]})]}),l.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[l.jsxs("div",{children:[l.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Expense Categories"}),l.jsx(ExpensePieChart,{data:s.expenseCategories})]}),l.jsxs("div",{children:[l.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Income Distribution"}),l.jsx(IncomePieChart,{data:s.incomeCategories})]})]})]}),l.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 shadow-md",children:[l.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Transactions"}),l.jsx(TransactionsTable,{data:(s==null?void 0:s.transactions)||[]})]})]})]}),l.jsxs("div",{className:"mt-8 text-sm text-gray-600 dark:text-gray-400",children:[l.jsx("h3",{className:"font-semibold mb-2",children:"AI Finance Assistant Disclaimer"}),l.jsx("p",{children:"Boogasi's AI-powered financial tools and insights are provided for informational and educational purposes only. The features currently simulate AI analysis and should not be considered as financial advice."})]})]})};export{Tt as default};
